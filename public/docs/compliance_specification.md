# 電子帳簿保存法（スキャナ保存）対応機能 実装仕様書

> [!IMPORTANT]
> **免責事項**: 
> 本仕様書に基づき実装されたシステムは、電子帳簿保存法の要件を考慮していますが、完全な法的適合性を保証するものではありません。導入・運用にあたっては、詳細を顧問税理士等の専門家にご確認ください。

## 1. 概要
本アプリを電子帳簿保存法（特にスキャナ保存制度）の法的要件に適合させるための追加機能仕様です。
主に「**検索機能の確保**」と「**真実性の確保（訂正・削除履歴）**」の2点に対応します。

## 2. 実装が必要な機能

### 2.1 検索機能の強化（必須要件）
「取引年月日」「取引金額」「取引先」の3項目について、以下の検索ができる必要があります。

*   **機能要件**:
    1.  **範囲指定検索**: 「日付（From-To）」および「金額（From-To）」で範囲を指定して検索できること。
    2.  **組み合わせ検索**: 日付、金額、取引先（企業名）の条件を**2つ以上組み合わせて（AND条件）**検索できること。
    3.  **UI**: 履歴ページに「詳細検索」ボタンを設置し、フィルタリング用のモーダルまたはアコーディオンメニューを展開する。

### 2.2 真実性の確保：訂正・削除履歴の保存（必須要件）
データの改ざん防止措置として、**「訂正または削除を行った事実および内容を確認できる」**仕組みを実装します。

*   **データ構造の変更**:
    *   既存の `Receipt` テーブルはそのまま維持し、変更履歴を保存する `ReceiptLog`（または `AuditLog`）テーブルを新設します。
*   **トリガー**:
    *   **更新時 (UPDATE)**: 変更前のデータ（Snapshot）をログに保存してから、データを更新する。
    *   **削除時 (DELETE)**: データを物理削除せず、`deletedAt` カラムを用いた「論理削除」に変更し、削除操作のログを保存する。
    *   **ログ項目**: 対象レシートID、操作タイプ（UPDATE/DELETE）、操作日時、操作ユーザー、変更前データ（JSON等で保存）。
*   **UI**:
    *   レシート詳細画面に「変更履歴」タブを追加し、過去の修正内容（いつ、誰が、何を修正したか）を閲覧可能にする。

---

## 3. データベース設計変更案 (Prisma Schema)

```prisma
model Receipt {
  id            Int       @id @default(autoincrement())
  // ...既存カラム...
  isActive      Boolean   @default(true) // 論理削除用フラグ
  logs          ReceiptLog[]
}

model ReceiptLog {
  id            Int      @id @default(autoincrement())
  receiptId     Int
  receipt       Receipt  @relation(fields: [receiptId], references: [id])
  operationType String   // "UPDATE", "DELETE"
  changedAt     DateTime @default(now())
  changedBy     String?  // ユーザーIDなど
  
  // 変更内容の記録（簡易的にJSONで保存するか、主要カラムを列挙するか）
  previousData  Json     // 変更前のスナップショット
}
```

## 4. 開発ステップ

### Phase 1: データベース・API改修
1.  `schema.prisma` に `ReceiptLog` モデルを追加し、`Receipt` に `isActive` (または `deletedAt`) を追加。
2.  マイグレーション実行 (`npx prisma migrate dev`).
3.  `POST /api/receipts/[id]` (UPDATE), `DELETE /api/receipts/[id]` を改修し、ログ保存処理を追加。
4.  `GET /api/receipts/list` を改修し、複雑なクエリパラメータ（範囲指定等）に対応させる。

### Phase 2: フロントエンド改修 (検索)
1.  `HistoryPage` に検索フィルターコンポーネントを追加（日付範囲、金額範囲、キーワード）。
2.  APIからのデータ取得ロジックを修正し、フィルター条件を渡せるようにする。

### Phase 3: フロントエンド改修 (履歴表示)
1.  詳細・編集モーダル内に「変更履歴」表示エリアを作成。
2.  削除ボタンの挙動を「論理削除」に変更し、一覧からは除外（またはグレーアウト）するよう修正。

## 5. 運用上の注意
*   本仕様はシステム要件を満たすものですが、実際の運用（入力期間の制限や事務処理規程の備え付けなど）も合わせて必要となります。
