# 適格請求書発行事業者公表システムWeb-API利用仕様書

## 1. システムの概要
本システム「Digital receipt database」は、個人事業主向けのレシート・経費管理アプリケーションです。
ユーザーがスマートフォン等で撮影したレシート画像から、OCR技術を用いて「登録番号（T番号）」を読み取り、その番号が実在する適格請求書発行事業者であるかを国税庁Web-APIを用いて確認します。

## 2. 公表情報の取得方法とフロー
本システムは、以下の手順で公表情報を取得します。

### 取得のトリガー
ユーザーがレシートをスキャン、または手動で「登録番号（インボイス番号）」を入力し、「検索」を実行した時点でAPIリクエストが発生します。

### 処理フロー
1.  **リクエスト送信**:
    *   システムは、ユーザーから入力された「登録番号（T + 13桁の数字）」をパラメータとして、国税庁Web-APIのエンドポイント (`/1/num`) にHTTPSリクエストを送信します。
2.  **レスポンス受信**:
    *   Web-APIから返却されたXML/JSONデータを受信します。
3.  **データ抽出**:
    *   レスポンスに含まれる「氏名又は名称（`name`）」等の情報を抽出します。
4.  **画面表示**:
    *   抽出した企業名・事業者名をユーザーの画面に「読み取り結果」として表示し、レシート情報の一部として自動補完します。

## 3. 取得した情報の利用目的
*   **経費入力の補助**: 登録番号から正確な「事業者名」を自動入力し、ユーザーの入力負荷を軽減するため。
*   **登録状況の確認**: 入力された番号が、現在有効な適格請求書発行事業者であるかを確認するため。

## 4. 利用・取得状況の把握機能
Web-API利用規約の要件に基づき、本システムはAPIの利用状況を以下の通り記録・管理します。

### ログの記録
Web-APIへのリクエストが発生する都度、以下の情報をシステム内のデータベース (`ApiUsageLog` テーブル) に記録します。
*   **アクセス日時**: リクエスト送信時刻
*   **実行ユーザーID**: どのユーザーアカウントからのリクエストか
*   **対象エンドポイント**: 利用したAPIの種類

### 管理・集計機能
システム管理者は、管理画面を通じて以下の情報をいつでも確認・出力可能です。
*   ユーザーごとの累計APIアクセス数
*   月次・日次のAPI利用回数推移

## 5. キャッシュによる負荷軽減策
Web-APIへの過度な負荷を避けるため、一度取得した事業者情報はシステム内のデータベース (`InvoiceIssuer` テーブル) に一定期間キャッシュ（一時保存）します。
同一の登録番号に対する再検索が行われた場合は、Web-APIへリクエストを行わず、キャッシュされた情報を優先して返却する仕様とします。
