
# 開発仕様書: レシート管理アプリ機能拡張

本ドキュメントは、レシート管理アプリケーションの機能拡張および仕様を記したものです。
**「データ軽量化」と「ハイブリッドストレージ」** を軸に、運用コストを抑えつつスケーラビリティを確保する設計とします。

**「システム根幹への影響が少ない順」** にフェーズ分けして開発を進めます。

---

## Phase 1: クライアント機能の強化 (Low Risk)
既存のデータベース構造を大きく変えず、UIやブラウザ側のロジックで完結する機能です。

### 1.1 履歴CSVのスマホ保存 (Client-side CSV Download)
現在のサーバーサイド生成 (`/api/receipts/export`) を、よりスマホでの保存を確実にするため、クライアントサイド生成に切り替えます。

**実装方針:**
*   **場所**: `app/history/page.tsx`
*   **ロジック**:
    1.  表示中のレシートデータ（JSON）をもとに、JavaScriptでCSV文字列を生成します。
    2.  BOM (`\uFEFF`) を付与し、Excel等での文字化けを防ぎます。
    3.  `Blob` オブジェクトを作成し、`URL.createObjectURL` でダウンロードリンクを生成・クリックさせます。
*   **メリット**: サーバーへの追加リクエストが不要になり、表示されているフィルタリング済みのデータをそのままDLできます。

### 1.2 勘定科目の自動仕訳と入力補助
ユーザーの手間を減らすため、入力画面で科目を自動提案します。

**実装アプローチ:**
1.  **データベース拡張**:
    *   `Receipt` モデルに `category` フィールド（String）を追加。
    *   必要に応じて `Category` マスターテーブルを作成（ユーザーごとのカスタム科目も視野に）。
2.  **自動判定ロジック**:
    *   **優先度1: 履歴からの学習**: 「過去に同じ店名（`companyName`）で保存された履歴」を検索し、最も直近または頻度の高いカテゴリーを自動セットします。（例: 前回「ダイソー」を「消耗品費」としたなら、今回も「消耗品費」を入れる）
    *   **優先度2: キーワード判定**: 店名に含まれるキーワードから推測します。
        *   「居酒屋」「バル」 → 接待交際費
        *   「タクシー」「パーキング」 → 旅費交通費
        *   「カフェ」「珈琲」 → 会議費
    *   **デフォルト**: 判定できない場合は「未分類」または「雑費」とします。
3.  **UI**:
    *   編集・詳細画面に「カテゴリー」選択プルダウンを追加。
    *   自動判定された項目が初期選択された状態で表示し、ユーザーが確認・修正保存できるようにします。

---

## データ保存・管理戦略 (Storage & Retention Strategy)

**コンセプト**:
*   **メタデータ (CSV/JSON)**: サーバーDBに保存（軽量なため）。
*   **画像データ (Photo)**: 容量圧迫を防ぐため、ユーザーごとの **Google Drive** に保存（Proユーザー）。

### 1. ハイブリッドストレージ構成
| ユーザー区分 | 保存可能枚数 | 画像データの保存先 | Google Drive連携 |
| :--- | :--- | :--- | :--- |
| **無料ユーザー** | **最大 5枚** | サーバー (Public Storage) | **不可** |
| **Proユーザー** | **無制限** | **ユーザー自身のGoogle Drive** | **必須** |

*   **無料枠 (～5枚)**:
    *   **保存先**: Webサーバー内のストレージ (`public/uploads`)、またはサーバーレス環境（Vercel等）の場合は **Vercel Blob** (無料枠) などのオブジェクトストレージ。
    *   **理由**: 枚数が少ないため、高価な専用ストレージを用意せずとも、アプリサーバーの付帯領域や無料枠で十分賄えるため。
    *   5枚を超えると保存できません（Proへのアップグレードが必要）。
*   **Pro枠 (6枚～)**:
    *   Stripe決済完了後、Googleアカウント連携を必須とします。
    *   画像は全てユーザーのGoogle Driveにアップロードされ、サーバーの容量を消費しません。

### 2. データ保存期間 (Retention Policy)
*   **CSV/メタデータ**: **7年保存**
    *   税法上の保存義務期間（7年）およびサーバー容量節約のため、作成から7年を経過したデータは自動的に削除します。
*   **自動削除の仕組み**:
    *   毎日1回実行されるバッチ処理 (Cron Job) を実装。
    *   条件: `createdAt < NOW() - 7 years` のレコードを物理削除。
    *   Google Drive上の画像ファイルについては、メタデータ削除時に連動して削除するか、ユーザー管理として残すかを選択可能にします（基本方針: メタデータ削除時はリンク切れとなるため、ユーザーに通知の上、アプリからは参照不可とする）。

---


## Phase 2: 外部データ連携 (Medium Risk)
外部サービス(API)を利用しますが、ユーザー認証自体はまだ必須としません。

### 2.1 インボイス番号のリアルタイム取得 (NTA API)
独自のデータベース照合に加え、国税庁の公式APIを利用します。

**必要要件:**
*   **アプリケーションID**: 国税庁Web-APIの利用申請を行い、アプリケーションIDを取得する必要があります。

**実装フロー (`app/api/invoice-lookup/route.ts`):**
1.  既存のローカルDB (`Receipt` 履歴, `InvoiceIssuer` テーブル) を検索。
2.  見つからない場合、国税庁APIへリクエスト送信。
    *   エンドポイント: `https://web-api.invoice-kohyo.nta.go.jp/1/num`
    *   パラメータ: `type=21`, `history=0`, `invoiceNumber=T...`
3.  APIレスポンスから `name` (商号) 等を取得し、クライアントに返却。
4.  取得した情報は `InvoiceIssuer` テーブルにキャッシュ保存し、次回以降の高速化を図ります。
8.  取得した情報は `InvoiceIssuer` テーブルにキャッシュ保存し、次回以降の高速化を図ります。

### 2.2 API利用状況の記録 (API Usage Logging)
「利用・取得状況を把握できる」という国税庁APIの要件を満たすため、各ユーザーが「いつ」「どれくらい」APIを利用したかを記録・集計する機能を実装します。

**実装内容:**
*   **ログ保存**: インボイスAPIを叩くたびに、`ApiUsageLog` テーブルに記録します。
*   **管理者機能**: 管理画面にて「ユーザーごとの累計アクセス数」を確認できるようにします。

```prisma
// スキーマ追加案
model ApiUsageLog {
  id        Int      @id @default(autoincrement())
  userId    String
  endpoint  String   // "NTA_INVOICE_API"
  timestamp DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}
```

### 2.3 Google Driveへの保存 (Google Drive Integration)
レシート画像をサーバーの `public/uploads` ではなく、Google Driveへアップロードします。

**実装方針:**
*   **認証**:
    *   **パターンA（ユーザー個人のDrive）**: ユーザーが自分のGoogleアカウントでログインし、OAuth 2.0のスコープで `drive.file` の権限を取得します。アクセストークンを使用してAPIを叩きます。
    *   **パターンB（システム共通のDrive）**: サービスアカウントを使用しまとめて管理します（今回は「ユーザーごとの設定」とあるため、パターンAが推奨されます）。
*   **保存フロー**:
    1.  フロントエンドからサーバーへ画像を送信。
    2.  サーバー（API Route）にて、Google Drive API (`googleapis` npm package) を使用してファイルをアップロード。
    3.  Driveから返却された `fileId` または `webViewLink` をデータベースの `imagePath` に保存します。
    4.  画像表示時は、Driveの画像を表示できるようにします（権限設定やプロキシ配信が必要になる場合があります）。

**ファイル名への反映（Naming Convention）:**
Google Drive等へ保存する際のファイル名を、検索性を高めるために以下の形式に統一します。
*   **形式**: `日付_社名_金額_支払い方法_カテゴリー.拡張子`
*   **例**: `20240106_セブンイレブン_500_d_消耗品費.jpg`
    *   **支払い方法コード**:
        *   `cr`: クレジットカード (Credit)
        *   `d`: 電子マネー (Digital/Den-money)
        *   `ca`: 現金 (Cash)
    *   **カテゴリー**: 具体的な勘定科目名（例: 消耗品費, 接待交際費）
これにより、OSやDriveの検索機能で「消耗品費」や「d (電子マネーのみ)」といった絞り込み検索が可能になります。

---

## Phase 3: 認証と収益化 (High Risk)
ユーザー認証を導入し、データ構造を「ユーザー単位」に厳格化します。システム根幹に関わる変更です。

### 3.1 ユーザー管理とアクセス制限 (Access Control)
「許可した人だけ使えるようにしたい」という要件に基づき、**招待制（ホワイトリスト方式）** を導入します。

1.  **認証と権限**:
    *   **管理者 (Admin)**: ユーザーの追加・削除権限を持ちます。
    *   **一般ユーザー (User)**: 管理者によってメールアドレスが登録された人のみログイン可能です。
    *   **トライアル/ゲスト (Trial)**: ログインなしで利用可能ですが、機能制限があります。
2.  **トライアル版の仕様**:
    *   **制限**: 「5枚まで」記録可能。
    *   **データ保存**: サーバーやGoogle Driveではなく、**ブラウザ内 (LocalStorage/IndexedDB)** に保存します。
### 3.1 ユーザー認証 (Authentication Strategy)
**「Googleログイン」を採用します。**

*   **ID/パスワード方式を採用しない理由**:
    1.  **利便性**: Pro版で「Google Drive連携」が必須となるため、ID/パスワード方式だと「アプリのログイン」＋「Google連携」の**2回ログイン**が必要になり、操作が煩雑になるため。
    2.  **セキュリティ**: パスワード管理（漏洩対策、リセット機能など）のコストを削減できるため。
*   **複数人利用への対応**:
    *   Googleログインを行った時点で、システム内部では一意の「ユーザーID」が発行されます。
    *   サーバーに保存される無料枠の画像も、この「ユーザーID」と紐付けられるため、**他人のデータと混ざることはありません**。
    *   複数人が同じPCを使う場合でも、ブラウザ上でログアウトすれば切り替え可能です。

### 3.2 データ隔離の徹底 (Strict Data Isolation)
**「CSVが混ざらないようにする」** ため、すべてのデータ取得処理において `userId` によるフィルタリングを強制します。

*   **実装ルール**:
    *   API (`/api/receipts/list`, `/api/receipts/export`) は、必ずセッションから `userId` を取得します。
    *   データベース検索時、`where: { userId: session.user.id }` を**必須条件**とします。
    *   `userId` が取得できない（未ログイン）場合は、データを1件も返却しません（またはエラー）。
*   **検証**:
    *   テストユーザーAとBを作成し、Aで保存したデータがBのCSVに含まれないことをテストで保証します。

### 3.2 有償版へのアップグレードフロー (Payment & Unlock) - Stripe
**「5件までは無料、以降はProのみ」** を実現します。

1.  **制限ロジック**:
2.  **Stripe決済**:
    *   決済完了 (Webhook受信) で `User.isPro = true` に更新。
    *   同時に、それまでサーバーに保存されていた5枚の画像をGoogle Driveへ移行するオプションも検討（今回は新規保存分から適用で最低限スタート）。


```prisma
// スキーマ変更案
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  receipts      Receipt[]
  settings      UserSettings?
}

model UserSettings {
  id            String @id @default(cuid())
  userId        String @unique
  driveFolderId String? // Google Driveの保存先フォルダID
  user          User   @relation(fields: [userId], references: [id])
}
```

### 3.2 有償版へのアップグレードフロー (Payment & Unlock) - Stripe
トライアル版（5枚制限）から、Stripe決済を通じて自動的に制限を解除するフローを実装します。

**実装アプローチ: Stripe Checkout & Webhook**
**完全自動化**を実現するため、Stripeのホスティング型決済ページ（Checkout）を利用します。

1.  **制限到達時**:
    *   ユーザーに「アップグレード（¥XXX/月 または 買い切り）」ボタンを表示。
2.  **決済フロー**:
    *   ボタン押下でStripeの決済画面へリダイレクト。
    *   カード情報入力＆支払い完了。
3.  **自動解除 (Webhook)**:
    *   Stripeからサーバーへ「支払い完了 (checkout.session.completed)」の通知が届く。
    *   サーバーがユーザーのステータスを `isPremium: true` に更新。
    *   ユーザーは完了画面に戻ると、即座に無制限で利用可能になる。

### データモデル変更
**Userモデル**:
*   `isPremium` (Boolean): 有料会員フラグ
*   `stripeCustomerId` (String): Stripe顧客ID

これにより、手動対応ゼロでのマネタイズが可能になります。

---

## 現在の進捗と次のステップ

1.  [ ] **Phase 1** の「CSVスマホ保存」「カテゴリー追加」から着手します。
2.  [ ] **Phase 2** のAPI設定を行います。
3.  [ ] **Phase 3** で認証と決済を実装します。

---

## 3. 今後の作業ステップ (TODO)

1.  [ ] **要件確定**: 具体的な認証方式（Googleログインのみで良いか等）の決定。
2.  [ ] **APIキー取得**:
    *   Google Cloud Console (Drive API, OAuth Client)
    *   国税庁Web-API (Application ID)
3.  [ ] **パッケージ導入**:
    *   `npm install googleapis next-auth`
4.  [ ] **開発実施**:
    *   スキーマ変更 (`prisma migrate`)
    *   認証機能実装
    *   APIルートの改修


---

## 4. Web公開・デプロイ戦略 (Deployment Strategy) - 完全無料プラン

「無料で運用したい」というご要望に基づき、すべてのコンポーネントで**無料枠 (Free Tier)** を提供しているサービスを選定しました。個人利用・小規模利用であれば、以下の構成で**月額0円**での運用が可能です。

### 推奨構成: Vercel + Vercel Postgres

*   **フロントエンド/バックエンド**: **Vercel (Hobby Plan)**
    *   **費用**: **0円** (個人・非商用)
    *   **特徴**: Next.jsに最適化されており、設定不要でHTTPS化されます。
*   **データベース**: **Vercel Postgres** (または Supabase / Neon)
    *   **費用**: **0円** (Hobby Plan / Free Tier)
    *   **容量**: 256MB〜500MB程度 (レシート履歴のテキストデータなら数万件以上保存可能)
*   **画像ストレージ**: **Google Drive (ユーザー個人のドライブ)**
    *   **費用**: **0円** (ユーザーの既存容量を使用)
    *   **特徴**: サーバーのストレージ容量を気にする必要がありません。

### 導入の手順

1.  **データベースの変更**:
    *   現在の `SQLite` (ファイル) はVercel等のクラウドでは使えないため、`PostgreSQL` に設定を変更します。
    *   `schema.prisma` の `datasource` を変更し、Vercelの管理画面で作成したデータベースのURLを環境変数に設定するだけで完了します。
2.  **デプロイ**:
    *   GitHubのリポジトリをVercelに連携するだけで、自動的にWebサイトとして公開されます。

**結論**:
この「Vercel + Postgres + Google Drive」の構成であれば、サーバー代、データベース代、ストレージ代をすべて無料で運用を開始できます。

---

## 5. スマホアプリ化 (Mobile App Strategy)

「スマホアプリとかにもできるの？」というご質問に対する回答と計画です。

### PWA (Progressive Web App) 対応【推奨】
App StoreやGoogle Playを通さずに、Webサイトをアプリのようにホーム画面に追加して使う技術です。
*   **メリット**:
    *   **追加開発ほぼ不要**: 現行のWebアプリに設定ファイル (`manifest.json`) を追加するだけで対応可能です。
    *   **審査なし**: Apple/Googleの審査不要で、すぐに配布・更新できます。
    *   **見た目**: ブラウザのアドレスバーが消え、ネイティブアプリと同じ全画面表示で操作できます。
*   **実装内容**:
    *   `manifest.json` の作成（アプリアイコン、名称設定）。
    *   サービスワーカーの設定（オフライン動作の向上）。
    *   「ホーム画面に追加」を促すUIの実装。
